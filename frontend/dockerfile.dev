FROM node:20-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies with specific focus on MSAL packages
RUN npm install
RUN npm install --save @azure/msal-react@^1.5.0 @azure/msal-browser@^2.32.0

# Copy tsconfig
COPY tsconfig.json ./

# Create a startup script
RUN echo '#!/bin/sh' > /startup.sh && \
    echo 'echo "Checking for MSAL packages..."' >> /startup.sh && \
    echo 'if [ ! -d "node_modules/@azure" ]; then' >> /startup.sh && \
    echo '  echo "MSAL packages not found, installing..."' >> /startup.sh && \
    echo '  npm install --save @azure/msal-react@^1.5.0 @azure/msal-browser@^2.32.0' >> /startup.sh && \
    echo 'fi' >> /startup.sh && \
    echo 'echo "Starting application..."' >> /startup.sh && \
    echo 'exec npm start' >> /startup.sh && \
    chmod +x /startup.sh

EXPOSE 3000

# Use the startup script
CMD ["/startup.sh"] 