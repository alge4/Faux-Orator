FROM node:20-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Explicitly install tslib
RUN npm install --save tslib

# Install global tools
RUN npm install -g ts-node-dev typescript

# Install additional dependencies
RUN npm install --save passport express-session
RUN npm install --save-dev @types/passport @types/express-session
RUN npm install --save cookie-parser
RUN npm install --save ws @types/ws

# Verify critical dependencies are installed
RUN npm list sequelize || npm install sequelize
RUN npm list pg pg-hstore || npm install pg pg-hstore
RUN npm list express-session || npm install express-session
RUN npm list passport || npm install passport

# Copy tsconfig
COPY tsconfig.json ./

EXPOSE 3000

# Create a startup script that respects tsconfig.json
RUN echo '#!/bin/sh' > /startup.sh && \
    echo 'echo "Installing tslib directly..."' >> /startup.sh && \
    echo 'npm install --no-save tslib' >> /startup.sh && \
    echo 'echo "Starting application with explicit module paths..."' >> /startup.sh && \
    echo 'NODE_PATH=/app/node_modules ts-node-dev --project /app/tsconfig.json --respawn --transpile-only src/app.ts' >> /startup.sh && \
    chmod +x /startup.sh

# Use the startup script
CMD ["/startup.sh"]